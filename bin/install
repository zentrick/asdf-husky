#!/usr/bin/env bash

set -Eeuo pipefail

TARBALL_URL="https://registry.npmjs.org/husky/-/husky-$ASDF_INSTALL_VERSION.tgz"

mkdir -p "$ASDF_INSTALL_PATH"

echo "Downloading husky v$ASDF_INSTALL_VERSION"

curl --silent --fail --show-error --location "$TARBALL_URL" |
  tar xzf - --strip-components=1 --no-same-owner -C "$ASDF_INSTALL_PATH"

# Get either "bin": "foo/bar.js" or "bin": { "husky": "foo/bar.js" }
BIN_DESCRIPTOR=$( tr -d '\n' < "$ASDF_INSTALL_PATH/package.json" | grep -Eo '"bin":[^,]*' )
# Extract the last quote-delimited string
BIN_PATH=$( sed 's/.*"\([^"]*\)".*/\1/' <<< "$BIN_DESCRIPTOR" )

[[ -z "$BIN_PATH" ]] && exit 1

chmod +x "$ASDF_INSTALL_PATH/$BIN_PATH"

mkdir -p "$ASDF_INSTALL_PATH/bin"

ln -sf "$ASDF_INSTALL_PATH/$BIN_PATH" "$ASDF_INSTALL_PATH/bin/husky"
